
<h1><%= t 'drugstores.title' %></h1>

<%= form_tag drugstores_path, :method => :get do %>
  <p>
    <%= text_field_tag :search, params[:search] %>
    <%= submit_tag t('drugstores.search_near'), :name => nil %>
  </p>
<% end %>


<%= link_to t('drugstores.new'), new_drugstore_path %>

<div class="row-fluid">
  <div class="col-md-10 col-xs-10">
    <div id="map" style='width: 100%; height: 300px;'></div>
  </div>
  <div class="col-md-2 col-xs-2", id="drugstore_info">
  </div>
</div>

<script type="text/javascript">
$(function(){

  handler = Gmaps.build('Google');
  handler.buildMap({ provider: {styles: mapStyle}, internal: {id: 'map'}}, function(){

    // set marker infos from gmaps4rails ruby @hash built in controller
    markers_json = <%=raw @hash.to_json %>;
    markers = _.map(markers_json, function(marker_json){
      marker = handler.addMarker(marker_json);
      _.extend(marker, marker_json);
      return marker;
    });

    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();

    // Add event listener on marker click
    for (var i = 0; i <  markers.length; ++i) {
      var marker = markers[i];
      google.maps.event.addListener(marker.serviceObject, 'click', onMarkerClick(marker, event));
    }

    function onMarkerClick(marker, event){
      return function(event){
        // On marker click, make AJAX request on "flats#show"
        $.get("/drugstores/" + marker.id);
      }
    }

  });

})
</script>