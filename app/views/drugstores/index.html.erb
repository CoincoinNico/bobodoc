
<h1><%= t 'drugstores.header' %></h1>
<div class="row-fluid">
<%= form_tag drugstores_path, :method => :get do %>
    <div class="col-md-5 col-xs-5">
      <%= text_field_tag :search, params[:search],:placeholder => t('drugstores.placeholder'), :style => "width:100%;"%>
    </div>
    <div class="col-md-2 col-xs-2">
      <button type="submit" class="btn btn-primary" >
        <%= t('drugstores.search_near') %>
      </button>
    </div>
<% end %>
</div>

<div class="row-fluid">
  <div class="col-md-10 col-xs-10">
    <div id="map" style='width: 100%; height: 500px;'></div>
  </div>
  <div class="col-md-2 col-xs-2", id="drugstore_info">
  </div>
</div>

<script type="text/javascript">
$(function(){

  handler = Gmaps.build('Google');
  handler.buildMap({ provider: {styles: mapStyle}, internal: {id: 'map'}}, function(){

    // set marker infos from gmaps4rails ruby @hash built in controller
    markers_json = <%=raw @hash.to_json %>;
    markers = _.map(markers_json, function(marker_json){
      marker = handler.addMarker(marker_json);
      _.extend(marker, marker_json);
      return marker;
    });

    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();

    // Add event listener on marker click
    for (var i = 0; i <  markers.length; ++i) {
      var marker = markers[i];
      google.maps.event.addListener(marker.serviceObject, 'click', onMarkerClick(marker, event));
    }

    function onMarkerClick(marker, event){
      return function(event){
        // On marker click, make AJAX request on "flats#show"
        $.get("/drugstores/" + marker.id);
      }
    }

  });

})
</script>